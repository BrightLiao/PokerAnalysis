# 德州扑克日志分析系统

一个功能强大的Poker Now德州扑克游戏日志分析工具，支持多日数据合并、自动玩家识别和全面的统计分析。

## ✨ 核心特性

- 🎯 **智能日志解析**：自动解析Poker Now CSV格式日志
- 📊 **全面统计分析**：支持20+种核心扑克指标
- 🔄 **多日数据合并**：自动合并跨天数据，生成汇总和单日统计
- 👥 **智能玩家识别**：自动识别并合并相似名称玩家
- 💾 **数据持久化**：JSON格式存储，方便二次分析
- 🛠️ **自动化脚本**：一键批量处理多天日志
- ✅ **数据验证**：零和验证、筹码一致性检查

## 当前进度

### ✅ 阶段一：数据基础（已完成）

- [x] CSV日志解析器
- [x] 数据模型（Hand、Action、Player）
- [x] JSON数据持久化
- [x] 数据完整性验证
- [x] Ledger账本集成
- [x] 筹码流转追踪
- [x] 玩家买入/补码记录

### ✅ 阶段二：统计分析（已完成）

- [x] 基础指标计算（VPIP、PFR、AF）
- [x] 3-Bet率和C-Bet率
- [x] 摊牌统计（WTSD、W$SD）
- [x] BB/100收益计算
- [x] 位置统计
- [x] Fold to C-Bet
- [x] 偷盲率（Steal Rate）
- [x] 胜率和弃牌率
- [x] 多日数据合并统计
- [x] 每日统计分解

## 项目结构

```
poker/
├── src/                          # 源代码
│   ├── parser/                  # 日志解析模块
│   │   ├── log_parser.py        # Poker Now CSV解析器
│   │   └── ledger_parser.py     # 账本解析器
│   ├── models/                  # 数据模型
│   │   ├── hand.py              # 手牌模型
│   │   ├── action.py            # 行动模型
│   │   └── player.py            # 玩家模型
│   ├── builder/                 # 数据构建器
│   │   ├── data_builder.py      # 事件转数据模型
│   │   └── multi_day_merger.py  # 多日数据合并器
│   ├── storage/                 # 数据持久化
│   │   └── json_storage.py      # JSON存储
│   └── analyzer/                # 统计分析模块
│       ├── statistics.py        # 单日统计
│       └── multi_day_statistics.py  # 多日统计
├── log/                         # 原始日志目录
│   ├── log_MMDD.csv            # 游戏日志
│   └── ledger_MMDD.csv         # 账本文件
├── data/                        # 数据输出目录
│   ├── MMDD/                   # 单日数据
│   │   ├── hands.json          # 手牌数据
│   │   ├── players.json        # 玩家数据
│   │   └── summary.json        # 摘要信息
│   └── merged/                 # 合并数据
├── parse_logs.sh               # 自动化批量解析脚本
├── main.py                     # 主程序
├── requirements.txt            # 依赖包
└── README.md                   # 本文件
```

## 安装

### 环境要求

- Python 3.8+
- 推荐使用Conda环境管理

### 安装步骤

```bash
# 1. 克隆仓库
git clone https://github.com/yourusername/poker-analyzer.git
cd poker-analyzer

# 2. 创建虚拟环境（推荐）
conda create -n pokerlog python=3.10
conda activate pokerlog

# 3. 安装依赖
pip install -r requirements.txt

# 4. 添加执行权限（如果使用自动化脚本）
chmod +x parse_logs.sh
```

## 快速开始

### 方法一：使用自动化脚本（推荐）

```bash
# 解析10月12日到10月25日的所有日志并生成统计
./parse_logs.sh 1012 1025 --stats

# 只解析，不生成统计
./parse_logs.sh 1012 1025

# 指定输出目录
./parse_logs.sh 1012 1025 -o data/october --stats
```

### 方法二：使用Python命令

#### 1. 解析单日日志

```bash
# 基本用法
python main.py parse log/log_1024.csv -l log/ledger_1024.csv -o data/1024

# 合并相似名称的玩家（如"黄笃读"和"黄笃读2"）
python main.py parse log/log_1024.csv -l log/ledger_1024.csv -o data/1024 -m

# 静默模式
python main.py parse log/log_1024.csv -l log/ledger_1024.csv -o data/1024 -m -q
```

#### 2. 合并多日数据

```bash
# 合并多天的数据
python main.py merge data/1012 data/1021 data/1022 -o data/merged

# 查看合并后的数据
python main.py load -d data/merged
```

#### 3. 分析统计指标

```bash
# 分析统计指标（自动识别单日/多日）
python main.py stats -d data/merged

# 查看单日统计
python main.py stats -d data/1024
```

## 数据模型说明

### Hand（手牌）
- `hand_id`: 手牌唯一标识
- `hand_number`: 手牌序号
- `timestamp`: 时间戳
- `dealer`: 庄家信息
- `players`: 参与玩家及筹码
- `small_blind`, `big_blind`: 盲注
- `flop`, `turn`, `river`: 公共牌
- `actions`: 各街行动序列
- `showdowns`: 摊牌信息
- `pot_size`: 底池大小
- `winners`: 赢家和金额

### Action（行动）
- `action_type`: 行动类型（fold/check/call/bet/raise/all_in）
- `player_name`, `player_id`: 玩家信息
- `amount`: 金额
- `street`: 所在街道（preflop/flop/turn/river）
- `timestamp`: 时间戳

### Player（玩家）
- `name`, `player_id`: 玩家标识
- `hands_played`: 参与手牌数
- `total_profit`: 总盈亏
- `hand_ids`: 手牌历史
- `starting_stacks`: 每手牌初始筹码

## 统计指标说明

### 基础指标
- **VPIP** (Voluntarily Put in Pot): 主动入池率，反映玩家松紧程度
- **PFR** (Pre-Flop Raise): 翻牌前加注率，反映玩家激进程度
- **AF** (Aggression Factor): 激进因子 = (下注+加注) / 跟注
- **3-Bet**: 面对加注后再加注的比例
- **C-Bet** (Continuation Bet): 翻牌前加注后在flop继续下注的比例

### 摊牌指标
- **WTSD** (Went To Showdown): 摊牌率，看到flop后到摊牌的比例
- **W$SD** (Won $ at Showdown): 摊牌胜率

### 高级指标
- **Fold to C-Bet**: 面对持续下注的弃牌率
- **Steal Rate**: 偷盲率（后位加注偷盲的比例）
- **Win Rate**: 胜率（赢得手牌的比例）
- **Fold Rate**: 总体弃牌率
- **Position Stats**: 不同位置的VPIP和PFR统计

### 收益指标
- **BB/100**: 每100手牌的大盲收益
- **总盈亏**: 玩家总盈亏金额（基于ledger账本）
- **每日盈亏**: 多日数据的每日盈亏分解

### 风格分类
- **紧凶** (TAG): VPIP 20-30%, PFR 15-25%, AF > 1.5
- **松凶** (LAG): VPIP > 30%, PFR > 20%, AF > 1.5  
- **紧弱** (Rock): VPIP < 25%, AF < 1.0
- **松弱** (Calling Station): VPIP > 35%, AF < 1.0

### 多日统计特性
- **总体统计**: 所有日期的汇总数据和指标
- **单日统计**: 每一天的独立统计和指标
- **盈亏追踪**: 跨天盈亏趋势和每日表现
- **数据验证**: 零和验证确保数据准确性

## 测试

项目包含多个测试脚本：

```bash
# 测试解析器
python test_parser.py

# 测试数据构建
python test_builder.py

# 测试存储功能
python test_storage.py

# 测试统计分析
python test_statistics.py
```

## 输出示例

### 单日解析输出

```
================================================================================
德州扑克日志分析系统 - 数据解析
================================================================================

步骤 1/3: 解析日志文件...
  文件: log/log_1024.csv
  ✓ 成功解析 1910 条事件

步骤 2/3: 构建数据模型...
✓ 零和规则验证通过（总盈亏: 0.00）

筹码验证:
--------------------------------------------------------------------------------
✓ yx          : 逐手=  +480.0, ledger=  +480.0, 差值=   0.0 (1次进场)
✓ vzzz        : 逐手=  +465.0, ledger=  +465.0, 差值=   0.0 (1次进场)
✓ ldl         : 逐手=   +78.0, ledger=   +78.0, 差值=   0.0 (1次进场)
--------------------------------------------------------------------------------
✓ 所有玩家筹码验证通过

玩家名称合并:
--------------------------------------------------------------------------------
合并玩家: 黄笃读, 黄笃读2 -> 黄笃读
✓ 成功合并 1 组玩家
--------------------------------------------------------------------------------
  ✓ 构建了 91 手牌
  ✓ 识别了 6 位玩家

步骤 3/3: 保存数据...
  ✓ 数据已保存到 data/1024/
      - hands.json (384.2 KB)
      - players.json (21.4 KB)
      - summary.json (0.2 KB)
```

### 多日统计输出

```
========================================================================================================================
多日统计汇总
========================================================================================================================

【总体统计】
========================================================================================================================
玩家            手牌   VPIP    PFR     AF  3-Bet  C-Bet  Steal   Fold     胜率         盈亏
------------------------------------------------------------------------------------------------------------------------
vzzz           488    32.4    20.1     1.3    6.7   36.8   29.1    85.9    10.7      +1453.0
gf             389    89.2    18.8     0.5    7.4   52.3   14.3    56.3    29.8       +852.0
xx             646    74.0    14.2     0.5    8.1   50.6   27.3    74.9    18.1       +509.0
...

【20251024 单日统计】
玩家            手牌   VPIP    PFR     AF  3-Bet  C-Bet  Steal   Fold     胜率         盈亏
------------------------------------------------------------------------------------------------------------------------
yx              50    78.0    22.0     0.6   14.3   70.0   10.0    70.0    22.0       +480.0
vzzz            86    39.5    30.2     1.5    0.0   30.0   30.0    79.1    19.8       +465.0
...
```

## 支持的日志格式

本系统支持 [Poker Now](https://www.pokernow.club/) 导出的CSV格式日志，包含以下信息：

### 游戏日志 (log_MMDD.csv)
- 手牌开始/结束
- 玩家行动（下注/跟注/加注/弃牌/过牌/all-in）
- 公共牌（Flop/Turn/River）
- 摊牌信息
- 底池收集
- 玩家筹码变动
- 玩家进场/离场/补码记录

### 账本文件 (ledger_MMDD.csv)
- 玩家买入记录
- 玩家离场金额
- 最终筹码余额
- 进场次数统计

## 核心功能详解

### 1. 智能玩家识别

自动识别并合并以下情况的玩家：
- 同一玩家的不同账号（如"黄笃读"和"黄笃读2"）
- 跨天游戏中的同一玩家
- 基于玩家ID的准确匹配

### 2. 数据验证

- **零和验证**: 确保所有玩家盈亏之和为0
- **筹码一致性**: 验证筹码流转的准确性
- **逐手验证**: 每手牌的盈亏计算和验证
- **买入追踪**: 准确记录初始买入、补码、离场

### 3. 多日数据处理

- 自动为手牌添加日期前缀（如`20251024_#1`）
- 合并跨天玩家的所有数据
- 生成总体统计和每日统计
- 盈亏趋势分析

### 4. 自动化脚本

`parse_logs.sh` 提供以下功能：
- 批量解析指定日期范围的日志
- 自动跳过不存在的日期
- 一键生成统计报告
- 灵活的参数配置

详细使用方法见 [PARSE_LOGS_GUIDE.md](PARSE_LOGS_GUIDE.md)

## 下一步计划

- [x] 阶段一：数据基础（已完成）
  - [x] CSV日志解析
  - [x] 数据模型设计
  - [x] JSON持久化
  - [x] Ledger集成
  - [x] 数据验证
  
- [x] 阶段二：统计分析（已完成）
  - [x] 核心指标计算
  - [x] 高级指标
  - [x] 多日数据合并
  - [x] 自动化脚本
  
- [ ] 阶段三：AI分析与点评（进行中）
  - [ ] LLM集成
  - [ ] 玩家风格分析
  - [ ] 手牌点评
  
- [ ] 阶段四：精彩手牌筛选
  - [ ] 大底池手牌
  - [ ] 特殊牌型
  - [ ] 文字回放生成
  
- [ ] 阶段五：HTML页面展示
  - [ ] 数据可视化
  - [ ] 交互式图表
  - [ ] 报告生成

## 技术栈

- **核心**: Python 3.8+
- **数据处理**: 标准库（csv, json, datetime, pathlib等）
- **环境管理**: Conda
- **未来计划**: pandas, numpy, ECharts, 大模型API

## 常见问题

### Q: 如何处理玩家名称重复？

使用 `-m` 参数自动合并相似名称：
```bash
python main.py parse log.csv -l ledger.csv -m
```

### Q: 支持哪些日期格式？

目前支持 `MMDD` 格式（如 `1024` 表示10月24日）。

### Q: 数据不一致怎么办？

检查以下几点：
1. ledger文件是否完整
2. 是否有玩家中途退出又重新进入
3. 查看验证输出中的具体差异

### Q: 如何批量处理多天数据？

使用自动化脚本：
```bash
./parse_logs.sh 1012 1025 --stats
```

## 贡献

欢迎提交Issue和Pull Request！

## 许可

MIT License

## 联系方式

如有问题或建议，欢迎提交Issue。

---

**注意**: 本项目仅用于学习和娱乐目的，请遵守当地法律法规。

